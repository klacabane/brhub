var Req=function(a,b){return m.request({method:a.method,url:"http://localhost:8000"+a.ep,data:a.data||{},config:function(a){if(a.setRequestHeader("Content-Type","application/json"),!b){var c=storage.getUser().token;a.setRequestHeader("X-token",c)}},extract:function(a){return a.status>=400?JSON.stringify({err:JSON.parse(a.responseText).msg,status:a.status}):a.responseText}})},storage={lsKey:"brhub-user",getUser:function(){var a=localStorage.getItem(this.lsKey),b=null;if(null===a)return null;try{b=JSON.parse(localStorage.getItem(this.lsKey))}catch(c){localStorage.removeItem(this.lsKey)}return b},setUser:function(a){null===a?localStorage.removeItem(this.lsKey):localStorage.setItem(this.lsKey,JSON.stringify(a))}},User={};User.signin=function(a,b){return Req({method:"POST",ep:"/auth",data:{name:a,password:b}},!0)};var Item={};Item.get=function(a){return Req({method:"GET",ep:"/api/items/"+a})},Item.create=function(a){return Req({method:"POST",ep:"/api/items/",data:a})};var Comments={};Comments.create=function(a){return console.log(a),Req({method:"POST",ep:"/api/comments/",data:a})};var Brhub={};Brhub.all=function(){return Req({method:"GET",ep:"/api/b/"})},Brhub.items=function(a,b,c){return a="timeline"===a?"timeline":"b/"+a,a+="/"+b+"/"+c,Req({method:"GET",ep:"/api/"+a})},Brhub.create=function(){return Req({method:"POST",ep:"/api/b/",data:{name:"f"}})};var app=app||{};!function(a){a.controller=function(){return null!==storage.getUser()?m.route("/timeline"):(this.name=m.prop(""),this.password=m.prop(""),void(this.signin=function(){User.signin(this.name(),this.password()).then(function(a){storage.setUser(a),m.route("/timeline")},app.utils.processError)}.bind(this)))},a.view=function(a){return m("div",[m("div",[m("input[name='username'][placeholder='Name'][type='text']",{onchange:m.withAttr("value",a.name)}),m("input[name='password'][placeholder='Password'][type='password']",{onchange:m.withAttr("value",a.password)}),m("input[type='submit'][value='swag me in']",{onclick:a.signin})])])}}(app.auth={});var app=app||{},comments=function(a,b){var c={};return c.vm={reply:new reply({parent:a.id,item:a.item}),parent:a,margin:b?0:40,childs:a.comments.map(function(a){return new comments(a)})},c.view=function(){return m("div",{style:{marginLeft:c.vm.margin+"px"}},[m("p",c.vm.parent.content),m("ul",[m("li","Reply")]),c.vm.reply.view(),m("div",c.vm.childs.map(function(a){return a.view()}))])},c},reply=function(a){var b={};return b.vm={parent:a.parent||"",item:a.item,content:m.prop(""),send:function(a){a.preventDefault(),Comments.create({item:this.item,parent:this.parent,content:this.content()}).then(function(a){console.log(a)},app.utils.processError)}},b.view=function(){return m("form",[m('textarea[name="content"]',{onchange:m.withAttr("value",b.vm.content)}),m('input[type="submit"][value="reply"]',{onclick:b.vm.send.bind(b.vm)})])},b},app=app||{};app.feed=function(a){var b={};return b.vm={init:function(){return null===storage.getUser()?m.route("/auth"):void(this.grid=new app.grid.controller({src:a||m.route.param("name")}))},signout:function(){storage.setUser(null),m.route("/auth")},submit:function(){m.route("/submit")}},b.controller=function(){b.vm.init()},b.view=function(){return m("div",[m("button",{onclick:b.vm.signout},"Signout"),m("button",{onclick:b.vm.submit},"New"),app.grid.view(b.vm.grid)])},b};var app=app||{};!function(a){"use strict";a.vm={src:"",current:0,limit:5,showPrev:!1,showNext:!1,items:m.prop([]),getItems:function(){Brhub.items(this.src,this.current,this.limit).then(function(a){this.showPrev=this.current>0,this.showNext=a.hasmore,this.items(a.items)}.bind(this),app.utils.processError)},getPrevItems:function(){this.current-=this.limit,this.current<0&&(this.current=0),this.getItems()},getNextItems:function(){this.current+=this.limit,this.getItems()}},a.controller=function(b){a.vm.src=b.src,a.vm.current=b.start||0,a.vm.getItems()},a.view=function(){return m("div",[a.vm.items().map(function(b){return m("div",[m("p",[m("a",{href:"link"===b.type?b.link:"/#/items/"+b.id},b.title)]),m("p",[m("span","by "+b.author.name),m("span",{onclick:function(){m.route("/b/"+b.brhub)},style:{display:"timeline"===a.vm.src?"inline":"none"}},b.brhub)]),m("p",[m("a",{href:"/#/items/"+b.id},1===b.commentCount?b.commentCount+" comment":b.commentCount+" comments")])])}),m("button",{onclick:a.vm.getPrevItems.bind(a.vm),style:{display:a.vm.showPrev?"inline":"none"}},"Prev"),m("button",{onclick:a.vm.getNextItems.bind(a.vm),style:{display:a.vm.showNext?"inline":"none"}},"Next")])}}(app.grid={});var app=app||{};!function(a){"use strict";a.controller=function(){if(null===storage.getUser())return m.route("/");var a=m.route.param("id");return/^[0-9a-fA-F]{24}$/.test(a)?(this.item=m.prop({}),this.commentModules=[],this.reply=new reply({item:a}),void Item.get(a).then(function(a){this.commentModules=a.comments.map(function(a){return new comments(a,!0)}),this.item(a)}.bind(this),app.utils.processError)):m.route("/timeline")},a.view=function(a){return m("div",[m("h2",a.item().title),m("p",a.item().content),a.reply.view(),m("div",a.commentModules.map(function(a){return a.view()}))])}}(app.items={});var app=app||{};!function(a){"use strict";var b="link",c="text";a.vm={init:function(a){return null===storage.getUser()?m.route("/auth"):(this.type=m.prop(a||b),this.title=m.prop(""),this.link=m.prop(""),this.content=m.prop(""),this.brhub=m.prop(""),this.brhubs=m.prop([]),void Brhub.all().then(this.brhubs,app.utils.processError))},submitItem:function(){var b=a.vm;Item.create({type:b.type(),title:b.title(),link:b.link(),content:b.content(),brhub:b.brhub()}).then(function(a){console.log(a),m.route("/b/"+b.brhub())},app.utils.processError)}},a.controller=function(){a.vm.init()},a.view=function(){return m("div",[m("ul",[m("li",{onclick:function(){a.vm.type(b)}},"Link"),m("li",{onclick:function(){a.vm.type(c)}},"Text")]),m('input[name="title"][type="text"]',{onchange:m.withAttr("value",a.vm.title)}),m('input[name="link"][type="text"]',{onchange:m.withAttr("value",a.vm.link),style:{display:a.vm.type()===b?"block":"none"}}),m('textarea[name="content"]',{onchange:m.withAttr("value",a.vm.content),style:{display:a.vm.type()===c?"block":"none"}}),m('input[name="brhub"][type="text"]',{value:a.vm.brhub()}),a.vm.brhubs().map(function(b){return m("span",{onclick:function(){a.vm.brhub(b.name)}},b.name)}),m('input[type="submit"][value="submit"]',{onclick:a.vm.submitItem})])}}(app.submit={}),function(a){"use strict";a.utils={processError:function(a){switch(console.log(a),a.status){case 401:case 403:storage.setUser(null),m.route("/auth");break;case 500:}}},m.route.mode="hash",m.route(document.body,"/",{"/auth":a.auth,"/":a.feed("timeline"),"/b/:name":a.feed(),"/items/:id":a.items,"/submit":a.submit})}(app=app||{});